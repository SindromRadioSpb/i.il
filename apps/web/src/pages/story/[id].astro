---
import Base from '../../layouts/Base.astro';
import { fetchStory } from '../../lib/api';

const { id } = Astro.params;
if (!id) return Astro.redirect('/');

let story = null;
try {
  const resp = await fetchStory(id);
  if (resp.ok) story = resp.data.story;
} catch {
  // API error — show 404
}

if (!story) {
  return new Response(null, { status: 404 });
}

const displayTitle = story.title_ru ?? 'Новость обрабатывается';
const description = story.summary_ru
  ? story.summary_ru.replace(/\n/g, ' ').slice(0, 160)
  : 'Подробности из израильских СМИ на русском языке.';

const lastUpdateLabel = new Date(story.last_update_at).toLocaleDateString('ru-RU', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
});

const CATEGORY_LABELS: Record<string, string> = {
  politics: 'Политика', security: 'Безопасность', economy: 'Экономика',
  society: 'Общество', tech: 'Технологии', health: 'Здоровье',
  culture: 'Культура', sport: 'Спорт', weather: 'Погода', other: 'Другое',
};
const categoryLabel = CATEGORY_LABELS[story.category] ?? story.category;
---

<Base
  title={`${displayTitle} — Новости Израиля`}
  description={description}
  canonicalPath={`/story/${id}`}
>
  <a href="/" class="back-link">← Вернуться к ленте</a>

  <article class="story">
    <header class="story__header">
      <div class="story__meta">
        <span class={`badge badge--${story.risk_level}`}>{categoryLabel}</span>
        <time datetime={story.last_update_at}>{lastUpdateLabel}</time>
      </div>
      <h1 class="story__title">{displayTitle}</h1>
    </header>

    {story.summary_ru ? (
      <section class="story__summary">
        {story.summary_ru.split('\n').filter(l => l.trim()).map((line) => (
          <p class={line.includes(':') && !line.startsWith('По') ? 'summary-section' : 'summary-body'}>
            {line}
          </p>
        ))}
      </section>
    ) : (
      <p class="notice">Резюме на русском языке формируется…</p>
    )}

    {story.sources.length > 0 && (
      <section class="story__sources">
        <h2>Источники</h2>
        <ul>
          {story.sources.map((src) => (
            <li>
              <a href={src.url} target="_blank" rel="noopener noreferrer">{src.name}</a>
            </li>
          ))}
        </ul>
      </section>
    )}

    {story.timeline.length > 0 && (
      <section class="story__timeline">
        <h2>Хронология</h2>
        <ul>
          {story.timeline.map((item) => (
            <li class="timeline-item">
              <a href={item.url} target="_blank" rel="noopener noreferrer" class="timeline-item__title" lang="he">
                {item.title_he}
              </a>
              {item.published_at && (
                <time datetime={item.published_at} class="timeline-item__time">
                  {new Date(item.published_at).toLocaleDateString('ru-RU', {
                    day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit',
                  })}
                </time>
              )}
            </li>
          ))}
        </ul>
      </section>
    )}
  </article>
</Base>

<style>
  .back-link {
    display: inline-block;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: var(--muted);
    text-decoration: none;
  }
  .back-link:hover { color: var(--accent); }

  .story__header { margin-bottom: 1.25rem; }
  .story__meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.6rem;
    font-size: 0.85rem;
    color: var(--muted);
  }
  .badge {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 4px;
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .badge--high { background: #fde8e8; color: var(--risk-high); }
  .badge--medium { background: #fef3e2; color: var(--risk-medium); }
  .badge--low { background: #e8f5e9; color: var(--risk-low); }

  .story__title {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.3;
  }

  .story__summary {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .summary-section {
    font-weight: 600;
    margin-top: 0.75rem;
    margin-bottom: 0.15rem;
  }
  .summary-section:first-child { margin-top: 0; }
  .summary-body { margin-bottom: 0.25rem; color: var(--text); }

  .notice { color: var(--muted); font-style: italic; }

  .story__sources, .story__timeline {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
  }
  .story__sources h2, .story__timeline h2 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.6rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-size: 0.8rem;
  }
  .story__sources ul, .story__timeline ul {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .story__sources a {
    font-size: 0.9rem;
  }

  .timeline-item {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }
  .timeline-item__title {
    font-size: 0.875rem;
    direction: rtl;
    text-align: right;
    font-family: 'Arial Hebrew', Arial, sans-serif;
  }
  .timeline-item__time {
    font-size: 0.75rem;
    color: var(--muted);
  }
</style>
