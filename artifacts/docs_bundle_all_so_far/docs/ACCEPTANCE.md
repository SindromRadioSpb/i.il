# docs/ACCEPTANCE.md — Definition of Done (DoD) Checklist

This document defines the acceptance criteria for the A1 system:
**Cloudflare Pages + Workers Cron + D1** news hub (HE → RU summaries + Facebook crossposting).

Use this as a release gate and as a per-feature checklist.

---

## 0) Global acceptance rules

A change is accepted only if:
- All required checks pass: **lint + typecheck + tests** (worker + web).
- No secrets are committed; no sensitive data is logged.
- Compliance rules are respected (summary-only + attribution + no FB scraping).
- Any behavior change is reflected in `docs/SPEC.md` and/or `docs/DECISIONS.md`.

---

## 1) Core pipeline — ingestion

### 1.1 Schedule & idempotency
- [ ] Cron ingestion runs on schedule (default: every 10 minutes).
- [ ] There is a **run lock/lease** preventing overlapping runs (no duplicates due to concurrency).
- [ ] Re-running the same Cron window does **not** create duplicate Items.
- [ ] Dedupe uses a stable unique key (`item_key = sha256(normalized_url)`).

### 1.2 Sources registry
- [ ] `sources/registry.yaml` is the authoritative source list.
- [ ] Each source has stable `id`, `type`, `url`, and `enabled` flag.
- [ ] Each source enforces `throttle` (min interval + max items per run).
- [ ] Adding a new source requires at least one test fixture (parser coverage).

### 1.3 Failure isolation
- [ ] If a source fails (fetch/parse), the run continues for other sources.
- [ ] Source failures are recorded with `run_id`, `source_id`, `phase`, `code`, `message`.

---

## 2) Normalization & dedupe

### 2.1 URL normalization
- [ ] Tracking params are removed: `utm_*`, `fbclid`, `gclid`, `yclid`, `ref`, `ref_src`.
- [ ] Host and scheme are normalized (lowercase).
- [ ] Trailing slash normalization is consistent (except root).

### 2.2 Secondary heuristics
- [ ] If two URLs differ but content/title indicates duplicate, the system can link/cluster them without publishing duplicates.
  - (At minimum: title_hash + time-window heuristic is implemented or explicitly documented as TODO.)

---

## 3) Story clustering (coverage without spam)

### 3.1 One event → one story
- [ ] Multiple items about the same event cluster into a single Story.
- [ ] A story timeline includes all linked items ordered by time.

### 3.2 Stable story identity
- [ ] Stories have deterministic identity (`story_key` or deterministic matching).
- [ ] The same event discovered later attaches to the existing story (within window).

### 3.3 Updates
- [ ] New items can update the story’s `last_update_at` and sources list.
- [ ] Story summary is refreshed only when rules allow (e.g., breaking or meaningful update).

---

## 4) Russian summary generation (quality gate)

### 4.1 Summary-only compliance
- [ ] The public hub publishes **original RU summaries** only.
- [ ] The system does **not** publish full source text verbatim.

### 4.2 Required RU format
Every published story includes:
- [ ] Title (1 line, factual)
- [ ] “Что произошло” (1–2 sentences)
- [ ] “Почему важно” (1 sentence)
- [ ] “Что дальше” (1 sentence or “ожидается обновление”)
- [ ] “Источники” (2–5 links when available)

### 4.3 Consistency checks
- [ ] Numbers in RU output match numbers in the source material (basic numeric guard).
- [ ] Dates/times are converted to readable RU format; originals are retained internally.
- [ ] Names/toponyms follow a consistent glossary (at least a baseline glossary exists).

### 4.4 Risk-bucket behavior
- [ ] Stories have `risk_level` (low/medium/high).
- [ ] For `high` risk:
  - [ ] No emotional wording; neutral tone.
  - [ ] Uses “по данным источников” language.
  - [ ] Requires ≥2 sources when available or records `source_count=1`.

---

## 5) Web publishing (Pages frontend)

### 5.1 Canonical URLs & SEO
- [ ] Each story has a stable canonical URL:
  - `/story/{yyyy-mm-dd}/{slug}-{story_id}` (or equivalent stable scheme)
- [ ] Pages render correct:
  - [ ] `<link rel="canonical" ...>`
  - [ ] OpenGraph tags (`og:title`, `og:description`, `og:url`)
  - [ ] Title/description are derived from story content.

### 5.2 Feed & story pages
- [ ] Feed page lists latest stories sorted by `last_update_at desc`.
- [ ] Story page includes summary, sources, and timeline of linked items.
- [ ] Web does not require secrets; reads from Worker API only.

### 5.3 Sitemap
- [ ] Sitemap contains published story URLs (either generated by web or served via API).

---

## 6) Facebook crossposting (official only)

### 6.1 Policy
- [ ] System posts only to our own Facebook Page via official API.
- [ ] No scraping of FB UI or unauthorized reading of third-party content.

### 6.2 Idempotency & retries
- [ ] A story is posted at most once (`fb_post_id` stored).
- [ ] Failures are recorded (`fb_status`, `fb_error_last`).
- [ ] Retries use backoff and are bounded (≤3 per run).

### 6.3 Post format
- [ ] FB post includes RU title + short bullets + canonical URL link.
- [ ] Hashtags are limited and derived from story category (1–3).

---

## 7) Observability & run history

### 7.1 Run records
- [ ] Every Cron run creates a `Run` record with:
  - [ ] start/end timestamps
  - [ ] status (success/partial_failure/failure)
  - [ ] counters (items_new, stories_new, published_web, published_fb, etc.)

### 7.2 Structured logging
- [ ] Logs include `run_id` and relevant entity IDs.
- [ ] No secrets in logs.
- [ ] No full article bodies in logs (truncate safely).

---

## 8) Security gates

- [ ] `.env.example` contains variable names only (no secrets).
- [ ] Production secrets are provided via Cloudflare secrets (Wrangler).
- [ ] Admin endpoints (if any) are disabled in prod by default and require auth in dev.

---

## 9) Testing gates (minimum)

### 9.1 Worker tests
- [ ] Unit tests: URL normalization, hashing, dedupe keys.
- [ ] Unit tests: story clustering match/no-match cases.
- [ ] Integration test: ingest mock source → create item → create story → publish state.
- [ ] Integration test: FB crosspost mock → stores fb_post_id, idempotent retry.

### 9.2 Web tests
- [ ] Feed renders.
- [ ] Story page renders and includes canonical/OG tags.
- [ ] API contract compatibility (basic schema checks).

---

## 10) Release checklist (for “portfolio-grade” release)

- [ ] `docs/SPEC.md` matches behavior.
- [ ] `docs/ARCHITECTURE.md` updated for any new components.
- [ ] `docs/SECURITY.md` and `docs/COMPLIANCE.md` reviewed.
- [ ] `docs/RUNBOOK.md` includes how to diagnose common failures.
- [ ] CI is green.
- [ ] A short demo script exists (how to show WOW in 2 minutes):
  - [ ] show feed
  - [ ] open a story (summary + sources + timeline)
  - [ ] show run history/health
  - [ ] show FB post created from canonical URL (optional)

---

## 11) Exit criteria (definition of “accepted”)

The system is accepted when:
- Ingestion runs reliably and idempotently.
- Stories are deduplicated and clustered correctly.
- RU summaries meet format and quality gates.
- Web pages are canonical + SEO-ready.
- FB crossposting is official, idempotent, and observable.
- Tests and docs prove the above.
