# docs/SPEC.md — Requirements & Constraints (A1: Cloudflare Pages + Workers Cron + D1)

## 1) Цель продукта

Система автоматически ведёт русскоязычный новостной хаб, собирая материалы из ивритоязычных источников, формируя **оригинальные русские summaries**, объединяя дубликаты в единые **Story**, публикуя на сайте (канонический источник), и выполняя автокросспостинг в Facebook Page (и опционально в другие каналы).

Ключевые цели:
- **Актуальность:** быстрый выпуск (минуты-десятки минут).
- **Полнота:** покрытие событий по всем темам без спама и дублей.
- **Качество:** понятный русский текст, корректные числа/даты/имена.
- **Минимум ручного труда:** человек вмешивается только в исключениях.
- **Портфолио-уровень:** архитектура, тесты, качество, комплаенс, наблюдаемость.

---

## 2) Область применения и ограничения

### 2.1 In-scope
- Ingestion из ивритоязычных новостных ресурсов через разрешённые каналы:
  - RSS / Atom
  - sitemap
  - публичные HTML-страницы (без обхода ограничений доступа)
- Нормализация и дедупликация новостных items
- Кластеризация items в story (одно событие → один story)
- Генерация русских summaries (summary-only) + атрибуция источника
- Публикация:
  - Website (каноническая страница story)
  - Facebook Page post (ссылкой на каноническую страницу)
- Метрики/логи/состояния запусков (Cron runs)

### 2.2 Out-of-scope (не делаем)
- Скрейпинг Facebook UI, обход доступов, парсинг чужих FB страниц через браузер-ботов
- Публикация полного текста источника (вербатим)
- “Слив” любых секретов (токены, ключи) в репозиторий/логи
- Сбор или профилирование персональных данных пользователей (PII) — по умолчанию запрещено

---

## 3) Определения (термины)

- **Source** — источник (RSS/sitemap/html) с правилами извлечения.
- **Item** — единица новости (обычно одна статья/материал).
- **Story** — кластер items, описывающих одно событие/тему.
- **Summary** — оригинальный русскоязычный пересказ (не копия исходника).
- **Run** — один запуск Cron pipeline (например каждые 10 минут).
- **Publication** — состояние публикации story в web и соцсетях.

---

## 4) Требования к функциональности

### 4.1 Реестр источников (sources/registry.yaml)
Система обязана поддерживать “sources as code”. Для каждого Source:
- `id`: стабильный (snake_case)
- `name`: человекочитаемое имя
- `type`: `rss` | `sitemap` | `html`
- `url`: стартовый URL
- `lang`: `he`
- `enabled`: `true|false`
- `throttle`:
  - `min_interval_sec`: минимум 10 сек между запросами к источнику
  - `max_items_per_run`: минимум 10, дефолт 30
- `parser`:
  - `entry_selector` / `content_selector` (для html)
  - `date_strategy`: `published|updated|now`
- `category_hints`: список из {politics, security, economy, society, tech, health, culture, sport, weather, other}

**Правило:** изменения источников проходят через PR и покрываются тестами (фикстуры).

---

### 4.2 Ingestion pipeline (Worker Cron)

#### 4.2.1 Расписание
- Cron ingestion: **каждые 10 минут**
- Daily digest (опционально): **08:00** и **20:00** по Asia/Jerusalem

#### 4.2.2 Поведение ingestion
Для каждого включённого Source:
1) Fetch источника с учётом `throttle`.
2) Извлечь candidate entries (links).
3) Для каждого candidate:
   - нормализовать URL (удалить tracking params)
   - вычислить `item_key` (см. ниже)
   - если item уже существует — обновить метаданные при необходимости, не дублировать
4) Для новых items:
   - извлечь заголовок, время (published/updated), краткий snippet (внутренний), источник, canonical URL
   - сохранить в D1
5) Отправить items в кластеризацию.

#### 4.2.3 Идемпотентность
Повторный запуск Cron **не должен** создавать дубликаты:
- дедуп по `item_key`
- все записи имеют стабильные уникальные ключи и ограничения в БД

---

### 4.3 Нормализация URL и ключи дедупликации

#### 4.3.1 Нормализация URL
- Удалять tracking параметры: `utm_*`, `fbclid`, `gclid`, `yclid`, `ref`, `ref_src`
- Приводить схему/хост к lower-case
- Удалять `www.` (если это не ломает домен)
- Удалять хвостовой `/` (кроме корня)

#### 4.3.2 item_key
`item_key = sha256(normalized_url)`

Дополнительно хранить:
- `title_hash = sha256(normalize_title(title))`
- `content_hash = sha256(normalize_text(snippet_or_extract))` (если доступно)

---

### 4.4 Кластеризация Items → Story

#### 4.4.1 Цель
Свести дубликаты (одно событие из разных источников) в один story и избежать спама.

#### 4.4.2 Базовый алгоритм (без тяжёлых ML)
Story ключ строится из:
- нормализованных токенов заголовка (иврит, без стоп-слов)
- временного окна (например 24 часа)
- доменных/категорийных подсказок

**Правило:** item присоединяется к существующему story, если:
- `published_at` попадает в окно story (±24 часа от story.start_at), и
- similarity(title_tokens, story.title_tokens) >= 0.55 (Jaccard), и
- не противоречит “жёстким разделителям” (например разные города/персоны при наличии явных маркеров)

Если подходящего story нет — создаётся новый.

#### 4.4.3 Обновления story
- story хранит список связанных items (ordered by time)
- при добавлении нового item story может обновить:
  - “best headline” (лучший заголовок)
  - набор источников
  - статус “breaking/updated”

#### 4.4.4 Будущее расширение
- Embeddings/semantic clustering (опционально) — отдельной фичей, без ломки базового алгоритма.

---

### 4.5 Генерация русских summaries (HE→RU)

#### 4.5.1 Формат summary (строго)
Каждый story публикуется в RU формате:

**Заголовок (1 строка):** коротко и фактологично  
**Что произошло:** 1–2 предложения  
**Почему важно:** 1 предложение  
**Что дальше:** 1 предложение (или “ожидается обновление”)  
**Источники:** 2–5 ссылок (только домены/названия источников)

#### 4.5.2 Длина и стоимость
- Целевая длина summary: **400–700 символов** RU (без “Источники”)
- Внутренний input для перевода/пересказа ограничить: **до 1 200–2 000 символов** исходного текста на item,
  чтобы держать бюджет и ускорять пайплайн.

#### 4.5.3 Качество и консистентность
Авто-проверки перед публикацией:
- **Числа:** все числовые значения должны сохраняться (проценты, суммы, даты)
- **Даты/время:** конвертировать в понятный RU формат, хранить оригинал в БД
- **Имена/топонимы:** единая транслитерация (глоссарий)
- **Запреты:** не добавлять “домыслы”; если факт не подтверждён — помечать как “по данным источников”

#### 4.5.4 Risk-bucket
Story получает флаг `risk_level`:
- `low`: обычные новости
- `medium`: политика/суды
- `high`: жертвы, теракты, медицина, ЧС

Для `high`:
- запрещены эмоциональные оценки
- обязателен вывод “по данным источников” + минимум 2 источника, если доступны
- допускается “hold for review” (опционально), но по умолчанию всё равно автоматизировано

---

### 4.6 Публикация на сайт (Cloudflare Pages)

#### 4.6.1 Каноничность
- У каждого story есть **канонический URL** вида:
  - `/story/{yyyy-mm-dd}/{slug}-{story_id}`
- На странице story:
  - RU summary
  - список источников (ссылки)
  - таймлайн обновлений (список items)
  - OpenGraph + canonical tags

#### 4.6.2 Индексация
- sitemap для web формируется (через web build или API endpoint) и содержит story URLs.
- OG метаданные обязательны (title/description/image, где доступно).

---

### 4.7 Кросспостинг в Facebook Page

#### 4.7.1 Политика
- Только официальная публикация в **нашу** Page через Pages API
- Никаких попыток читать/скрейпить чужой FB контент

#### 4.7.2 Формат FB поста
- 1 строка: RU заголовок
- 2–4 буллета (выжимка)
- ссылка на канонический story URL
- хэштеги 1–3 (из категории story)

#### 4.7.3 Идемпотентность
- В БД хранить `fb_post_id`, `fb_status`, `fb_posted_at`, `fb_error_last`
- Повторная попытка публикации:
  - если `fb_post_id` есть и статус `posted` — не повторять
  - если `failed` — ретраи с backoff (макс 3 попытки на run)

---

## 5) Нефункциональные требования

### 5.1 Надёжность
- Cron run не должен “падать целиком” из-за одного источника.
- Ошибки источника логируются и сохраняются (per-source error record).
- У каждого run есть `run_id`, статусы и счётчики.

### 5.2 Производительность
Сценарий A: 50 items/day (≈ 1–2 items/run при 10-мин Cron).
- Время одного run: целевой бюджет **< 30 секунд**
- Внутри run:
  - batch DB операции
  - ограничение per-source max items
  - ограничение общего числа новых items за run (дефолт 25)

### 5.3 Rate limiting & backoff
- На fetch источников: уважать `Retry-After` и 429/503
- На внешние API (перевод/FB): экспоненциальный backoff, максимум 3 попытки/операция/run

### 5.4 Наблюдаемость
- Структурные логи, корреляция: `run_id`, `source_id`, `story_id`
- Хранить агрегаты run: `items_found`, `items_new`, `stories_new`, `stories_updated`, `published_web`, `published_fb`, `failed`
- Не логировать полный текст статей; максимум — безопасно обрезанные фрагменты

---

## 6) Безопасность и комплаенс (обязательные ссылки на политики проекта)
См.:
- `docs/SECURITY.md` — секреты, ключи, сетевой доступ, логирование
- `docs/COMPLIANCE.md` — summary-only, атрибуция, запреты на scraping

---

## 7) Конфигурация (env vars — кратко)
Полный список — в `.env.example`.

Минимум для dev:
- `PUBLIC_API_BASE_URL` (web)
- `CRON_ENABLED=false` (worker, чтобы вручную триггерить)

Для production:
- секреты перевода (если применимо)
- `FACEBOOK_PAGE_ACCESS_TOKEN` (secret)
- `FACEBOOK_PAGE_ID`
- `CRON_ENABLED=true`

---

## 8) Edge cases (обязательное поведение)

1) **Пустой/битый RSS**: пометить source error, продолжить run.
2) **Нет даты публикации**: использовать `now` и отметить `date_confidence=low`.
3) **Одинаковая новость разными URL**:
   - дедуп по title_hash + time window (2 часа) как secondary heuristic.
4) **Paywall / пустой текст**:
   - публиковать только по заголовку + краткому доступному snippet, отметить `content_confidence=low`.
5) **Смешанный язык** (he+en): допускать, но summary всегда ru.
6) **Скачок количества entries**: ограничить `max_items_per_run` и записать предупреждение.
7) **Facebook API error**:
   - 401/403: пометить “auth_error”, прекратить FB попытки до следующего run
   - 429: backoff и retry не более 1 раза в этом run
8) **Параллельные Cron**:
   - предотвращать двойной run через DB lock/lease (например запись “run_lock” с TTL)

---

## 9) Минимальные публичные API контракты (Worker)

### 9.1 Read-only endpoints (для web)
- `GET /api/feed?limit=20&cursor=...` → список story карточек
- `GET /api/story/{story_id}` → подробности story (summary, items, источники)
- `GET /api/health` → статусы (без секретов)

### 9.2 Admin endpoints (опционально, защищённые)
- `POST /api/admin/cron/run` → ручной запуск ingestion (dev only)
- `POST /api/admin/story/{id}/rebuild` → пересборка summary (dev only)

Правило: admin endpoints должны требовать секрет/подпись и по умолчанию выключены в prod.

---

## 10) “Готово” в рамках SPEC (критерии)
Система считается соответствующей SPEC, если:
- ingestion каждые 10 минут работает идемпотентно
- на сайте появляется лента stories (без дублей)
- у story есть RU summary по формату
- у story есть атрибуция и ссылки на источники
- FB кросспостинг создаёт 1 пост на story и не дублирует
- есть run history и структурные логи
- соблюдён summary-only и запрет scraping Facebook
